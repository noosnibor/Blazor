@page "/user"

@rendermode InteractiveServer

@inject ToastService ToastService
@inject ILocationService LocationService
@inject ICurrencyService CurrencyService
@inject IUserService UserService
@inject UserSession User
@inject IJSRuntime JS

<!--Auto scroll-->
<div id="autoScroll"></div>

<div class="container-fluid ">

    <!-- ========== Form =========== -->
    <EditForm Model="parameter" OnValidSubmit="OnFormSubmit" @ref="form">
        <DataAnnotationsValidator />

        <!-- ========== Header ========== -->
        <div class="section-header d-flex justify-content-between align-items-center">

            <div class="d-flex align-items-center">
                <img width="50" height="50" src="/img/user.png" class="me-2" />

                <div class="d-flex flex-column">
                    <span class="fw-semibold">User Module</span>
                    <small class="lh-1 small-text">Manage how payments are collected</small>
                </div>
            </div>

            <div>
                <button class="btn btn-sm @(canUpdate ? "btn-info text-black" : "btn-primary text-white") border-0"
                        type="submit"
                        disabled="@submitting">
                    @if (submitting)
                    {
                        <span class="spinner-border spinner-border-sm me-2"
                              role="status"
                              aria-hidden="true"></span>
                        <span>Saving...</span>
                    }
                    else
                    {
                        @(canUpdate ? "Update User" : "Add User")
                    }
                </button>

                <button class="btn btn-sm btn-secondary border-0"
                        type="button"
                        @onclick="ResetProperties">
                    Discard
                </button>
            </div>
        </div>

        <!-- ========== Content ========== -->
        <div class="card border-1 rounded-0 p-4">
            <div class="row mt-3">


                <!-- Left Side -->
                <div class="col-lg-6">

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-semibold">First Name</label>
                           
                            <InputText class="form-control"
                                       @bind-Value="parameter.fstrFirstname" placeholder="Enter a first name" />
                            <ValidationMessage For="@(() => parameter.fstrFirstname)" />
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-semibold">Last Name</label>
                            <div class="col-sm-9">
                                <InputText class="form-control"
                                           @bind-Value="parameter.fstrLastname" placeholder="Enter a last name" />
                                <ValidationMessage For="@(() => parameter.fstrLastname)" />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-semibold">Username</label>
                            <InputText class="form-control"
                                       @bind-Value="parameter.fstrUsername" placeholder="Enter a user name" />
                            <ValidationMessage For="@(() => parameter.fstrUsername)" />
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-semibold">Password</label>
                            <div class="col-sm-9">
                                <InputText class="form-control"
                                           @bind-Value="parameter.fstrPassword"
                                           disabled />
                                <ValidationMessage For="@(() => parameter.fstrPassword)" />
                            </div>
                        </div>
                    </div>

                    <label class="form-label fw-semibold">Email Address</label>
                    <div class="col-12">
                        <InputText class="form-control"
                                   @bind-Value="parameter.fstrEmailAddress" placeholder="Enter an email address" />
                        <ValidationMessage For="@(() => parameter.fstrEmailAddress)" />
                    </div>
                   
                </div>

                <!-- Right Side -->
                <div class="col-lg-6">

                    <div class="mb-3">
                        <label class="form-label fw-semibold">Role</label>
                        <InputSelect class="form-select"
                                     @bind-Value="parameter.flngRoleKey"
                                     TValue="int?">
                            <option value="">Select role</option>
                            @foreach (var r in MemoryStoredData.GetRoles())
                            {
                                <option value="@r.flngRoleKey">@r.fstrRoleName</option>
                            }
                        </InputSelect>
                        <ValidationMessage For="@(() => parameter.flngRoleKey)" />
                    </div>

                    <div class="row">
                          <div class="col-md-6 mb-3">
                            <label class="form-label fw-semibold">Campus</label>
                            <InputSelect TValue="string"
                                         class="form-select"
                                         Value="parameter.fstrLocationKey"
                                         ValueChanged="OnSelectedValueChanged"
                                         ValueExpression="() => parameter.fstrLocationKey">

                                <option value="">Select location</option>

                                @foreach (var l in locationModel)
                                {
                                    <option value="@l.fstrLocationKey">
                                        @l.fstrLocationName
                                    </option>
                                }

                            </InputSelect>

                            <ValidationMessage For="@(() => parameter.fstrLocationKey)" />
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-semibold">Currency</label>
                            <InputSelect class="form-select"
                                         @bind-Value="parameter.fstrCurrencyKey" disabled>
                                <option value="">Select currency</option>
                                @foreach (var c in currencyModel)
                                {
                                    <option value="@c.fstrCurrencyKey">@c.fstrCurrencyType</option>
                                }
                            </InputSelect>
                            <ValidationMessage For="@(() => parameter.fstrCurrencyKey)" />
                        </div>

                      
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-semibold">Effective From</label>
                            <div class="col-sm-9">
                                <InputDate class="form-control"
                                           @bind-Value="parameter.fdtmStart" />
                                <ValidationMessage For="@(() => parameter.fdtmStart)" />
                            </div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-semibold">Effective To</label>
                            <InputDate class="form-control"
                                       @bind-Value="parameter.fdtmEnd" />
                            <ValidationMessage For="@(() => parameter.fdtmEnd)" />
                        </div>
                    </div>

                    <div class="row mb-3 align-items-center">
                        <div class="col-12 pt-2">
                            <div class="border rounded p-3">
                                <div class="form-check">
                                    <InputCheckbox class="form-check-input"
                                                   type="checkbox"
                                                   id="autoCloseIssues"
                                                   @bind-Value="parameter.fblnActive" />

                                    <label class="form-check-label fw-semibold"
                                           for="autoCloseIssues">
                                        Activate User
                                    </label>

                                    <div class="text-muted small mt-1">
                                        A user must be active to log into the system
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                </div>

            </div>
        </div>

    </EditForm>

    <!--Table-->
    <div class="mt-3">
        <div class="section-header d-flex justify-content-between align-items-center mt-5">

            <div class="d-flex align-items-center">
                <img width="50" height="50" src="/img/table.png" class="me-2" />

                <div class="d-flex flex-column">
                    <span class="fw-semibold">Table Data</span>
                    <small class="lh-1 small-text">Show all active and inactive currencies</small>
                </div>
            </div>

            <div>
                <button class="btn btn-sm btn-secondary border-0"
                        type="button"
                        disabled="@reload"
                        @onclick="ReloadTableData">
                    @if (reload)
                    {
                        <span class="spinner-border spinner-border-sm me-2"
                              role="status"
                              aria-hidden="true"></span>
                        <span>Refreshing Table...</span>
                    }
                    else
                    {
                        @("Refresh")
                    }
                </button>
            </div>
        </div>
        <Pagination TItem="UserModel"
                    Items="userModel"
                    OnRowClick="SelectedUser"
                    SearchPredicate="SearchUser"
                    ColumnCount="7" >

            <HeaderTemplate>
                <tr>
                    <th>Full Name </th>
                    <th>Email Address</th>
                    <th>Location</th>
                    <th>Role</th>
                    <th>Active</th>
                    <th>Start Date</th>
                    <th>End Date</th>
                </tr>
            </HeaderTemplate>

            <RowTemplate Context="user">
                <td>
                    @user.fstrFirstname @user.fstrLastname
                </td>

                <td><span class="text-muted">@user.fstrEmailAddress</span></td>

                <td>@user.fstrLocationKey</td>
                <td><span class="text-muted">@MemoryStoredData.GetRoles().FirstOrDefault(x => x.flngRoleKey == user.flngRoleKey)!.fstrRoleName</span></td>
                <td>
                    <span class="badge @(user.fblnActive ? "bg-success-subtle text-success" : "bg-danger-subtle text-danger")  fs-12 p-1">@(user.fblnActive ? "Active" : "Not Active")</span>
                </td>
                <td><span class="text-muted">@user.fdtmStart.ToString("MMM dd, yyyy")</span></td>
                <td><span class="text-muted">@user.fdtmEnd.ToString("MMM dd, yyyy")</span></td>

            </RowTemplate>

        </Pagination>
    </div>
</div>

@code {

    private UserDto parameter = new();
    private IEnumerable<LocationModel> locationModel = [];
    private IEnumerable<CurrencyModel> currencyModel = [];
    private IEnumerable<UserModel> userModel = [];
    private bool submitting = false;
    private bool canUpdate = false;
    private bool reload = false;

    private EditForm? form;

    protected override async Task OnInitializedAsync()
    {
        await LoadAllDataAsync();
    }

    private async Task LoadAllDataAsync()
    {
        try
        {
            currencyModel = await CurrencyService.SelectCurrency(null, User.LocationKey, true) ?? [];
            locationModel = await LocationService.SelectLocation(null, true) ?? [];
            userModel = await UserService.SelectUser(null, null, null);
        }
        catch (Exception ex)
        {
            ToastService.ShowError(ex.Message);
        }

    }

    private async Task OnSelectedValueChanged(string value)
    {

        try
        {
            parameter.fstrLocationKey = value;
            currencyModel = await CurrencyService.SelectCurrency(null, value, true) ?? [];
            parameter.fstrCurrencyKey = currencyModel.FirstOrDefault(x => x.fcurAmount == 1)?.fstrCurrencyKey;

            await InvokeAsync(StateHasChanged);

            form?.EditContext?.Validate();
        }
        catch (Exception ex)
        {
            ToastService.ShowError(ex.Message);
        }

    }

    private async Task SelectedUser(UserModel user)
    {
        canUpdate = true;
        parameter = new()
        {
            flngUserKey = user.flngUserKey!,
            fstrUsername = user.fstrUsername!,
            fstrFirstname = user!.fstrFirstname!,
            fstrLastname = user.fstrLastname!,
            fstrEmailAddress = user.fstrEmailAddress!,
            fstrLocationKey = user.fstrLocationKey!,
            flngRoleKey = user.flngRoleKey,
            fblnActive = user.fblnActive,
            fdtmStart = user.fdtmStart,
            fdtmEnd = user.fdtmEnd,
            fstrPassword = user.fstrPassword!
        };

        currencyModel = await CurrencyService.SelectCurrency(null, user.fstrLocationKey!, true) ?? [];
        parameter.fstrCurrencyKey = currencyModel.FirstOrDefault(x => x.fcurAmount == 1)?.fstrCurrencyKey;

        await JS.InvokeVoidAsync("scrollToElement", "autoScroll");
    }

    private bool SearchUser(UserModel user, string searchText)
    {
        if (string.IsNullOrWhiteSpace(searchText))
            return true;

        return user.fstrUsername!.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
        user.fstrFirstname!.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
        user.fstrLastname!.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
        user.fstrEmailAddress!.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
        user.fstrLocationKey!.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
        MemoryStoredData.GetRoles()
        .FirstOrDefault(x => x.flngRoleKey == user.flngRoleKey)!
        .fstrRoleName!
        .Contains(searchText, StringComparison.OrdinalIgnoreCase);
    }

    private async Task OnFormSubmit()
    {
        submitting = true;
        await Task.Delay(1000);

        try
        {
            if (parameter.fstrUsername == "")
                return;


            var message = await (canUpdate ? UserService.AddOrUpdateUser(parameter, false) : UserService.AddOrUpdateUser(parameter));

            ToastService.Show(message.Type, message.Message!);
        }
        catch (Exception ex)
        {
            ToastService.ShowError(ex.Message);
        }
        finally
        {
            await ResetProperties();
        }
    }

    private async Task ResetProperties()
    {
        parameter = new();
        locationModel = [];
        submitting = false;
        canUpdate = false;

        await LoadAllDataAsync();
    }

    private async Task ReloadTableData()
    {
        await LoadAllDataAsync();
    }
}
