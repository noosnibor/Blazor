@page "/summaryreport"

@rendermode InteractiveServer

@inject ToastService ToastService
@inject ILocationService LocationService
@inject ICurrencyService CurrencyService
@inject ICollectionService CollectionService
@inject IReportService ReportService
@inject UserSession User
@inject IJSRuntime JS



<div class="container-fluid">

	<!-- ========== Form =========== -->
	<EditForm Model="parameter" OnValidSubmit="OnFormSubmit">
		<DataAnnotationsValidator />

		<!-- ========== Header ========== -->
		<div class="section-header d-flex justify-content-between align-items-center">

			<div class="d-flex align-items-center">
				<img width="50" height="50" src="/img/summary.png" class="me-2" />

				<div class="d-flex flex-column">
					<span class="fw-semibold">Summary Module</span>
					<small class="lh-1 small-text">Return summary information for payment types and collection types</small>
				</div>
			</div>

			<div>
				<button class="btn btn-sm btn-primary text-white border-0"
						type="submit"
						disabled="@submitting">
					@if (submitting)
					{
						<span class="spinner-border spinner-border-sm me-2"
							  role="status"
							  aria-hidden="true"></span>
						<span>Saving...</span>
					}
					else
					{
						<span>Generate</span>
					}
				</button>

				<button class="btn btn-sm btn-secondary border-0"
						type="button"
						@onclick="ResetProperties">
					Discard
				</button>
			</div>
		</div>

		<!-- ========== Content ========== -->
		<div class="card border-1 rounded-0 p-4">
			<div class="row mt-3">
				<!-- Left Side -->
				<div class="col-lg-6">

					<label class="form-label fw-semibold">Campus</label>
					<InputSelect class="form-select mb-3"
								 @bind-Value="LocationKey">
						<option value="">Select All Campuses</option>
						@foreach (var l in location!)
						{
							<option value="@l.fstrLocationKey">@l.fstrLocationName</option>
						}
					</InputSelect>
					<ValidationMessage For="@(() => parameter.LocationKey)" />
					@*  <AuthorizeView Policy="AdminOnly" Context="authState">
                        <Authorized>
                            <InputSelect class="form-select"
                                         @bind-Value="parameter.LocationKey">
                                @foreach (var l in location!)
                                {
                                    <option value="@l.fstrLocationKey">@l.fstrLocationName</option>
                                }
                            </InputSelect>
                            <ValidationMessage For="@(() => parameter.LocationKey)" />
                        </Authorized>
                        <NotAuthorized>
                            <InputSelect class="form-select"
                                         @bind-Value="parameter.LocationKey" disabled>
                                @foreach (var l in location!)
                                {
                                    <option value="@l.fstrLocationKey">@l.fstrLocationName</option>
                                }
                            </InputSelect>
                            <ValidationMessage For="@(() => parameter.LocationKey)" />
                        </NotAuthorized>
                    </AuthorizeView> *@

					<div class="row">
						<div class="col-md-6 mb-3">
							<label class="form-label fw-semibold">Collection Date From</label>
							<InputDate class="form-control"
									   @bind-Value="parameter.TransactionDateFrom"
									   max="@DateTime.Today.ToString("yyyy-MM-dd")" />
							<ValidationMessage For="@(() => parameter.TransactionDateFrom)" />
						</div>

						<div class="col-md-6 mb-3">
							<label class="form-label fw-semibold">Collection Date To</label>
							<InputDate class="form-control"
									   @bind-Value="parameter.TransactionDateTo"
									   max="@DateTime.Today.ToString("yyyy-MM-dd")" />
							<ValidationMessage For="@(() => parameter.TransactionDateTo)" />
						</div>
					</div>
				</div>

			</div>
			<div class="row">
				<InputRadioGroup @bind-Value="SelectedOption" class="w-100">
					<div class="row g-3">

						@foreach (var option in FilteredOptions)
						{						
							<div class="col-md-4">
								<InputRadio class="btn-check"
											Value="option.Value"
											id="@option.Value" />

								<label class="card radio-card h-100 p-3 text-center"
									   for="@option.Value">

									<div class="mb-2">
										<i class="@option.Icon fs-2 text-primary"></i>
									</div>

									<h6 class="fw-bold">@option.Title</h6>
									<small class="text-muted">@option.Description</small>

								</label>
							</div>
						}

					</div>
				</InputRadioGroup>
			</div>
		</div>

	</EditForm>

	<!--Table-->
	<div class="mt-3">
		<div class="section-header d-flex justify-content-between align-items-center mt-5">

			<div class="d-flex align-items-center">
				<img width="50" height="50" src="/img/table.png" class="me-2" />

				<div class="d-flex flex-column">
					<span class="fw-semibold">Table Data</span>
					<small class="lh-1 small-text">Show payment and collection list and montly summary</small>
				</div>
			</div>

			<div>
				<span class="text-success-emphasis">@paymentTypeSummary.GrandTotal.ToString("C2")</span>
			</div>
		</div>

		<!--Auto scroll-->
		<div id="autoScroll"></div>
		<div class="Card border-1 rounded-0">
			<table class="table table-borderless table-responsive text-center align-middle">
				<thead class="border-bottom">
					<tr>
						<th></th>
						@if (SelectedOption == "paymentsummary")
						{
							@foreach (var p in paymentSummary.Months!)
							{
								<th class="fw-bold text-end">@p</th>
							}
						}


						@if (SelectedOption == "collectionsummary")
						{
							@foreach (var p in collectionSummary.Months!)
							{
								<th class="fw-bold text-end">@p</th>
							}
						}

						@if (SelectedOption == "allcampus")
						{
							@foreach (var p in locationSummary.Months!)
							{
								<th class="fw-bold text-end">@p</th>
							}
						}

						@if (SelectedOption == "paymentlist")
						{
							@foreach (var currency in paymentTypeSummary.Currencies!)
							{
								<th class="text-end">@currency</th>
							}
							<th class="fw-bold text-end">Total</th>
						}


						@if (SelectedOption == "collectionlist")
						{
							@foreach (var currency in collectionTypeSummary.Currencies!)
							{
								<th class="text-end">@currency</th>
							}
							<th class="fw-bold text-end">Total</th>
						}
					
					</tr>
				</thead>

				<tbody>

					@if (SelectedOption == "paymentsummary")
					{
						@foreach (var row in paymentSummary.Data!)
						{
							<tr>
								<td class="text-start">@row.Id</td>

								@foreach (var p in paymentSummary.Months!)
								{
									<td class="text-end">@Format(row.Amount[p])</td>
								}
							</tr>
						}

					}


					@if (SelectedOption == "collectionsummary")
					{
						@foreach (var row in collectionSummary.Data!)
						{
							<tr>
								<td class="text-start">@row.Id</td>

								@foreach (var p in collectionSummary.Months!)
								{
									<td class="text-end">@Format(row.Amount[p])</td>
								}
							</tr>
						}

					}

					@if (SelectedOption == "allcampus")
					{
						@foreach (var row in locationSummary.Data!)
						{
							<tr>
								<td class="text-start">@row.Id</td>

								@foreach (var p in locationSummary.Months!)
								{
									<td class="text-end">@Format(row.Amount[p])</td>
								}
							</tr>
						}

					}


					@if (SelectedOption == "paymentlist")
					{

						@foreach (var paymentType in paymentTypeSummary.PaymentTypes!)
						{
							<tr>
								<td class="text-start">@MemoryStoredData.GetPaymentType().FirstOrDefault(x => x.flngPaymentKey == paymentType)!.fstrPaymentType</td>

								@foreach (var currency in paymentTypeSummary.Currencies!)
								{


									<td class="text-end">
										@(paymentTypeSummary.CellTotals.TryGetValue((paymentType, currency), out var value)
																	? value.ToString("N2")
																	: "-")
									</td>
								}




								<!-- Row Total -->
								<td class="fw-bold text-end">
									@(paymentTypeSummary.RowTotals.TryGetValue(paymentType, out var rowVal)
																? rowVal.ToString("N2")
																	: "0.00")
								</td>
							</tr>
						}
					}


					@if (SelectedOption == "collectionlist")
					{

						@foreach (var collectionType in collectionTypeSummary.CollectionTypes!)
						{
							<tr>
								<td class="text-start">@MemoryStoredData.GetCollectionType().FirstOrDefault(x => x.flngCollectionTypeKey == collectionType)!.fstrCollectionType</td>

								@foreach (var currency in paymentTypeSummary.Currencies!)
								{


									<td class="text-end">
										@(collectionTypeSummary.CellTotals.TryGetValue((collectionType, currency), out var value)
																	? value.ToString("N2")
																	: "-")
						</td>
												}




							<!-- Row Total -->
							<td class="fw-bold text-end">
								@(collectionTypeSummary.RowTotals.TryGetValue(collectionType, out var rowVal)
															? rowVal.ToString("N2")
															: "0.00")
						</td>
					</tr>
										}
					}


				</tbody>

				<tfoot class="table-success">
					@if (SelectedOption == "paymentsummary")
					{
						<!-- GRAND TOTAL -->
						<tr class="fw-bold border-top text-success">

							<th class="fw-bold text-start text-success">Grand Total:</th>
							@foreach (var p in paymentSummary.Months!)
							{
								<th class="fw-bold text-end text-success">
									@Format(paymentSummary.Data!.Sum(r => r.Amount[p]))
								</th>
							}

						</tr>
					}


					@if (SelectedOption == "collectionsummary")
					{
						<!-- GRAND TOTAL -->
						<tr class="fw-bold border-top text-success">

							<th class="fw-bold text-start text-success">Grand Total:</th>
							@foreach (var p in collectionSummary.Months!)
							{
								<th class="fw-bold text-end text-success">
									@Format(collectionSummary.Data!.Sum(r => r.Amount[p]))
								</th>
							}

						</tr>
					}

					@if (SelectedOption == "allcampus")
					{
						<!-- GRAND TOTAL -->
						<tr class="fw-bold border-top text-success">

							<th class="fw-bold text-start text-success">Grand Total:</th>
							@foreach (var p in locationSummary.Months!)
							{
								<th class="fw-bold text-end text-success">
									@Format(locationSummary.Data!.Sum(r => r.Amount[p]))
								</th>
							}

						</tr>
					}


					@if (SelectedOption == "paymentlist")
					{
						<tr>
							<th class="fw-bold text-start text-success">Total</th>

							@foreach (var currency in paymentTypeSummary.Currencies!)
							{

								<th class="fw-bold text-success text-end">
									@(paymentTypeSummary.ColumnTotals.TryGetValue(currency, out var colVal)
																? colVal.ToString("N2")
																: "0.00")
						</th>
												}

							<!-- Grand Total -->
							<th class="fw-bold table-success text-success text-end">
								@(paymentTypeSummary.GrandTotal.ToString("C2") ?? "0.00")
							</th>
						</tr>
					}


					@if (SelectedOption == "collectionlist")
					{
						<tr>
							<th class="fw-bold text-start text-success">Total</th>

							@foreach (var currency in collectionTypeSummary.Currencies!)
							{

								<th class="fw-bold text-success text-end">
									@(collectionTypeSummary.ColumnTotals.TryGetValue(currency, out var colVal)
																? colVal.ToString("N2")
																: "0.00")
						</th>
												}

							<!-- Grand Total -->
							<th class="fw-bold table-success text-success text-end">
								@(collectionTypeSummary.GrandTotal.ToString("C2") ?? "0.00")
							</th>
						</tr>
					}


				</tfoot>
			</table>
		</div>
		
	</div>

</div>

@code {

	private SummaryReportDto parameter = new();
	private IEnumerable<LocationModel>? location = [];

	private PaymentTypeSummary paymentTypeSummary = new();
	private CollectionTypeSummary collectionTypeSummary = new();

	private MonthlySummary paymentSummary = new();
	private MonthlySummary collectionSummary = new();
	private MonthlySummary locationSummary = new();

	private List<RadioButtonModel> Options = new();

	private IEnumerable<RadioButtonModel> FilteredOptions =>
		string.IsNullOrEmpty(LocationKey)
			? Options.Where(o => o.Value == "allcampus")      // Only All Campus
			: Options.Where(o => o.Value != "allcampus");     // Everything except All Campus

	private bool submitting = false;

	private string _selectedOption = "paymentlist";
	private string SelectedOption
	{
		get => _selectedOption;
		set
		{
			if (SelectedOption != value)
			{
				_selectedOption = value;
				_ = OnOptionClicked(value);
			}
		}
	}

	private string LocationKey
	{
		get => parameter.LocationKey!;
		set
		{
			if (parameter.LocationKey != value)
			{
				parameter.LocationKey = value;

				SelectedOption = null!;

				ResetProperties();

				StateHasChanged(); // Force UI refresh
			}
		}
	}

	protected override async Task OnInitializedAsync()
	{	
		await OnLoad();
	}

	protected override void OnParametersSet()
	{
		if (!string.IsNullOrEmpty(parameter.LocationKey) &&
			SelectedOption == "allcampus")
		{
			SelectedOption = null!;
		}
	}

	private async Task OnLoad()
	{
		Options = new()
		{
			new RadioButtonModel
			{
				Value = "paymentlist",
				Title = "Payment Type List",
				Description = "Show payment type and currency amount",
				Icon = "bi bi-credit-card-2-front-fill"
			},
			new RadioButtonModel
			{
				Value = "paymentsummary",
				Title = "Payment Montly Summary",
				Description = "SHow payment type and monthly totals",
				Icon = "bi bi-credit-card-2-back-fill"
			},
			new RadioButtonModel
			{
				Value = "collectionlist",
				Title = "Collection Type List",
				Description = "Show collection type and currency amount",
				Icon = "bi bi-calendar3"
			},
			new RadioButtonModel
			{
				Value = "collectionsummary",
				Title = "Collection Monthly Summary",
				Description = "Show collection type and monthly totals",
				Icon = "bi bi-calendar3"
			},
			new RadioButtonModel
			{
				Value = "allcampus",
				Title = "Monthly Summary for all Campuses",
				Description = "Show monthly totals for all campuses",
				Icon = "bi bi-calendar3"
			}
		};
		parameter = new()
			{
				LocationKey = User.LocationKey
			};

		location = await LocationService.SelectLocation(null, true);

	}

	private async Task OnOptionClicked(string value)
	{
		await JS.InvokeVoidAsync("scrollToElement", "autoScroll");
	}

	private string Format(decimal value)
	{
		if (value < 0)
		{
			return $"({Math.Abs(value):N2})";
		}
		else if (value == 0)
		{
			return "-";
		}
		else
		{
			return value.ToString("N2");
		}


	}

	private async Task OnFormSubmit()
	{
		submitting = true;
		await Task.Delay(1000);
		try
		{

			paymentTypeSummary = await ReportService.GeneratePaymentType(parameter!);
			paymentSummary = await ReportService.GenerateMonthlySummaryByPaymentType(parameter!);

			collectionTypeSummary = await ReportService.GenerateCollectionType(parameter!);
			collectionSummary = await ReportService.GenerateMonthlySummaryByCollectionType(parameter!);

			locationSummary = await ReportService.GenerateMonthlySummaryByLocation(parameter!);

			if (paymentTypeSummary.GrandTotal == 0 || !paymentSummary.Months.Any() || collectionTypeSummary.GrandTotal == 0|| !collectionSummary.Months.Any() || !locationSummary.Months.Any())
			{
				ToastService.ShowWarning("No data found");
			}

			await JS.InvokeVoidAsync("scrollToElement", "autoScroll");

		}
		catch (Exception ex)
		{
			ToastService.ShowError(ex.Message);
		}
		finally
		{
			submitting = false;
		}
	}

	private void ResetProperties()
	{
		paymentTypeSummary = new();
		collectionTypeSummary = new();

		paymentSummary = new();
		collectionSummary = new();
		locationSummary = new();

		// Options = new();
		submitting = false;
	}
}
