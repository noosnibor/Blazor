@page "/collection"

@rendermode InteractiveServer

@inject ToastService ToastService
@inject ILocationService LocationService
@inject ICurrencyService CurrencyService
@inject ICollectionService CollectionService


<div class="container-fluid ">

    <!-- ========== Form =========== -->
    <EditForm Model="parameter" OnValidSubmit="OnFormSubmit">
        <DataAnnotationsValidator />

        <!-- ========== Header ========== -->
        <div class="section-header d-flex justify-content-between align-items-center">
            <span>Collection Module</span>
            <span class="">
                <select class="form-select form-select-sm"
                        @bind="selectedCollectionNumber"
                        @bind:after="OnSelectedValueChanged"
                        aria-label="Small select example">
                    @foreach (var item in MemoryStoredData.GetCollectionNumber())
                    {
                        <option value="@item.flngCollectionNumberKey">@item.fstrCollectionNumberType</option>
                    }
                </select>
            </span>
            <div>
                <button class="btn btn-sm @(canUpdate ? "btn-info text text-black" : "btn-primary text-white") border-0"
                        type="submit"
                        disabled="@submitting">
                    @if (submitting)
                    {
                        <span class="spinner-border spinner-border-sm me-2"
                              role="status"
                              aria-hidden="true"></span>
                        <span>Saving...</span>
                    }
                    else
                    {
                        @(canUpdate ? "Update Collection" : "Add Collection")
                    }

                </button>
                <button class="btn btn-sm btn-secondary border-0"
                        type="button"
                        @onclick="ResetProperties">
                    Discard
                </button>
            </div>
        </div>

        <!-- ========== Content ========== -->
        <div class="row mt-3">

            <!-- Left Side -->
            <div class="col-lg-6">

                <div class="row mb-3 align-items-center">
                    <label class="col-sm-3 col-form-label">Collection No.</label>
                    <div class="col-sm-9">
                        <InputNumber class="form-control"
                                   @bind-Value="selectedCollectionNumber"
                                   disabled />
                        <ValidationMessage For="@(() => parameter.CollectionNumber)" />
                    </div>
                </div>

                <div class="row mb-3 align-items-center">
                    <label class="col-sm-3 col-form-label">Collection Date</label>
                    <div class="col-sm-9">
                        <InputDate TValue="DateTime?"
                                   class="@("form-control " + FormValidation.Required(false, parameter.TransactionDate))"
                                   Value="@parameter.TransactionDate"
                                   ValueChanged="OnDateChanged"
                                   ValueExpression="@(() => parameter.TransactionDate)" />

                        <ValidationMessage For="@(() => parameter.TransactionDate)" />
                    </div>
                </div>

                <div class="row mb-3 align-items-center">
                    <label class="col-sm-3 col-form-label">Collection Type</label>
                    <div class="col-sm-9">
                        <InputSelect class="@("form-control " + FormValidation.Required(true, parameter.CollectionTypeKey))"
                                     @bind-Value="parameter.CollectionTypeKey">
                            @foreach (var c in MemoryStoredData.GetCollectionType().Where(a => a.fblnActive == true).ToList())
                            {
                                <option value="@c.flngCollectionTypeKey">@c.fstrCollectionType</option>
                            }
                        </InputSelect>
                        <ValidationMessage For="@(() => parameter.CollectionTypeKey)" />
                    </div>
                </div>

                <div class="row mb-3 align-items-center">
                    <label class="col-sm-3 col-form-label">Status</label>
                    <div class="col-sm-9">
                        <InputSelect class="@("form-control " + FormValidation.Required(true, parameter.MemberStatusKey))"
                                     @bind-Value="parameter.MemberStatusKey">
                            @foreach (var m in MemoryStoredData.GetMemberStatus().Where(a => a.fblnActive == true).ToList())
                            {
                                <option value="@m.flngMemberStatusKey">@m.fstrMemberStatus</option>
                            }
                        </InputSelect>
                        <ValidationMessage For="@(() => parameter.MemberStatusKey)" />
                    </div>
                </div>

                <div class="row mb-3 align-items-center">
                    <label class="col-sm-3 col-form-label">Currency</label>
                    <div class="col-sm-9">
                        <InputSelect class="@("form-control " + FormValidation.Required(true, parameter.CurrencyKey))"
                                     @bind-Value="parameter.CurrencyKey">
                            @foreach (var c in currencyModel!)
                            {
                                <option value="@c.fstrCurrencyKey">@c.fstrCurrencyType</option>
                            }
                        </InputSelect>
                        <ValidationMessage For="@(() => parameter.CurrencyKey)" />
                    </div>
                </div>

            </div>

            <!-- Right Side -->
            <div class="col-lg-6">

                <div class="row">

                    <div class="row mb-3 align-items-center">
                        <label class="col-sm-3 col-form-label">Email Address</label>
                        <div class="col-sm-9">        
                            <InputText class="@("form-control " + FormValidation.Required(true, parameter.EmailAddress))"
                                       @bind-Value="parameter.EmailAddress"
                                       placeholder="Required" />
                            <ValidationMessage For="@(() => parameter.EmailAddress)" />
                        </div>
                    </div>

                     <div class="row mb-3 align-items-center">
                        <label class="col-sm-3 col-form-label">First Name</label>
                        <div class="col-sm-9">        
                            <InputText class="@("form-control " + FormValidation.Required(true, parameter.Firstname))"
                                       @bind-Value="parameter.Firstname"
                                       placeholder="Required" />
                            <ValidationMessage For="@(() => parameter.Firstname)" />
                        </div>
                    </div>

                    <div class="row mb-3 align-items-center">
                        <label class="col-sm-3 col-form-label">Last Name</label>
                        <div class="col-sm-9">
                            <InputText class="@("form-control " + FormValidation.Required(true, parameter.Lastname))"
                                       @bind-Value="parameter.Lastname"
                                       placeholder="Required" />
                            <ValidationMessage For="@(() => parameter.Lastname)" />
                        </div>
                    </div>

                    <div class="row mb-3 align-items-center">
                        <label class="col-sm-3 col-form-label">Amount</label>
                        <div class="col-sm-9">
                            <InputNumber class="@("form-control " + FormValidation.Required(true, parameter.Amount))"
                                         @bind-Value="parameter.Amount" />
                            <ValidationMessage For="@(() => parameter.Amount)" />
                        </div>
                    </div>

                    <div class="row mb-3 align-items-center">
                        <label class="col-sm-3 col-form-label">Payment Type</label>
                        <div class="col-sm-9">
                            <InputRadioGroup @bind-Value="parameter.PaymentTypeKey">
                                @foreach (var p in MemoryStoredData.GetPaymentType().Where(a => a.fblnActive == true).ToList())
                                {
                                    <div class="form-check">
                                        <InputRadio class="form-check-input"
                                                    Value="@p.flngPaymentKey" />

                                        <label class="form-check-label">
                                            @p.fstrPaymentType
                                        </label>
                                    </div>
                                }
                            </InputRadioGroup>

                            <ValidationMessage For="@(() => parameter.PaymentTypeKey)" />
                        </div>
                    </div>

                </div>
            </div>

        </div>

        <!-- ========== Summary ========== -->
        <div class="row mt-3">
            <!--Left Side-->
            <div class="col-lg-6">
                <div class="card mb-3 ">

                    <!-- Header -->
                    <div class="card-header d-flex justify-content-between align-items-center bg-secondary-subtle">
                        <div class="d-flex align-items-center">
                            @*   <img width="30" height="30"
                                                src="https://img.icons8.com/3d-fluency/94/chart.png"
                                                class="me-2" /> *@
                            <span class="fs-6  text-black">Payment Type Summary</span>
                        </div>
                    </div>

                    <div class="card-body bg-secondary-subtle">
                        <div class="d-flex flex-column gap-2">

                            @foreach (var item in sumPaymentTypeModel)
                            {
                                <div class="d-flex align-items-center">
                                    <span class=" me-2">@MemoryStoredData.GetPaymentType().FirstOrDefault(s => s.flngPaymentKey == item.flngPaymentTypeKey)!.fstrPaymentType</span>
                                    <span class="flex-grow-1 border-bottom border-dotted text-black mx-2"></span>
                                    <span class="fw-semibold text-muted">@item.fcurAmount.ToString("C2")</span>
                                </div>
                            }

                        </div>
                    </div>

                    <div class="card-footer bg-secondary-subtle">
                        <div class="d-flex flex-column gap-2">

                            <div class="d-flex align-items-center">
                                <span class="fw-bold me-2">Grand Total</span>
                                <span class="flex-grow-1 border-bottom border-dotted text-black mx-2"></span>
                                <span class="fw-bold text-black">@grandTotal.ToString("C2")</span>
                            </div>

                        </div>
                    </div>

                </div>
            </div>

            <!--Right Side-->
            <div class="col-lg-6">
                <div class="card mb-3 ">

                    <!-- Header -->
                    <div class="card-header d-flex justify-content-between align-items-center bg-secondary-subtle">
                        <div class="d-flex align-items-center">
                            @*   <img width="30" height="30"
                                                src="https://img.icons8.com/3d-fluency/94/chart.png"
                                                class="me-2" /> *@
                            <span class="fs-6 text-black">Collection Type Summary</span>
                        </div>
                    </div>

                    <div class="card-body bg-secondary-subtle">
                        <div class="d-flex flex-column gap-2">

                            @foreach (var item in sumCollectionTypeModel)
                            {
                                <div class="d-flex align-items-center">
                                    <span class="me-2">@MemoryStoredData.GetCollectionType().FirstOrDefault(s => s.flngCollectionTypeKey == item.flngCollectionTypeKey)!.fstrCollectionType</span>
                                    <span class="flex-grow-1 border-bottom border-dotted text-black mx-2"></span>
                                    <span class="fw-semibold text-muted">@item.fcurAmount.ToString("C")</span>
                                </div>
                            }

                        </div>
                    </div>

                    <div class="card-footer bg-secondary-subtle">
                        <div class="d-flex flex-column gap-2">

                            <div class="d-flex align-items-center">
                                <span class=" me-2 fw-bold">Grand Total</span>
                                <span class="flex-grow-1 border-bottom border-dotted text-black mx-2"></span>
                                <span class="fw-bold text-black">@grandTotal.ToString("C2")</span>
                            </div>

                        </div>
                    </div>

                </div>
            </div>
        </div>

    </EditForm>


    <div class="mt-3">
        <Pagination TItem="CollectionModel"
                    Items="collectionModel"
                    OnRowClick="SelectedCollection"
                    SearchPredicate="SearchCollection"
                    ColumnCount="8">

            <HeaderTemplate>
                <tr>
                    <th>Name</th>
                    <th>Member Type</th>
                    <th>Collection Type</th>
                    <th>Payment Type</th>
                    <th>Currency</th>
                    <th>Amount</th>
                    <th>Local Amount</th>
                    <th>Submitted By</th>
                </tr>
            </HeaderTemplate>

            <RowTemplate Context="collection">
                <td>@(collection.fstrFirstname + " " + collection.fstrLastname) </td>
                <td>@MemoryStoredData.GetMemberStatus().FirstOrDefault(m => m.flngMemberStatusKey == @collection.flngMemberStatusKey)!.fstrMemberStatus </td>
                <td>@MemoryStoredData.GetCollectionType().FirstOrDefault(m => m.flngCollectionTypeKey == @collection.flngCollectionTypeKey)!.fstrCollectionType </td>
                <td>@MemoryStoredData.GetPaymentType().FirstOrDefault(m => m.flngPaymentKey == @collection.flngPaymentTypeKey)!.fstrPaymentType </td>
                <td>@collection.fstrCurrencyKey</td>
                <td>@collection.fcurAmount.ToString("N2")</td>
                <td>@collection.fcurLocalAmount.ToString("N2")</td>
                <td>
                    <span class="badge bg-success-subtle text-success">
                        @collection.fstrWho
                    </span>
                </td>

            </RowTemplate>

        </Pagination>
    </div>


</div>



@code {
    private CollectionDto parameter = new();
    private IEnumerable<LocationModel> locationModel = [];
    private IEnumerable<CurrencyModel> currencyModel = [];
    private IEnumerable<CollectionModel> collectionModel = [];
    private IEnumerable<SumCollectionTypeModel> sumCollectionTypeModel = [];
    private IEnumerable<SumPaymentTypeModel> sumPaymentTypeModel = [];
    private bool submitting = false;
    private bool canUpdate = false;
    private int selectedCollectionNumber = 0;
    private decimal grandTotal = 0;


    protected override async Task OnInitializedAsync()
    {
        parameter = new()
            {
                CurrencyKey = "JMD",
                LocationKey = "HQ"
            };
        await LoadAllDataAsync();
    }
    private async Task OnSelectedValueChanged() => await LoadAllDataAsync();

    private async Task LoadAllDataAsync()
    {
        try
        {
            locationModel = await LocationService.SelectLocation(null, true) ?? [];
            currencyModel = await CurrencyService.SelectCurrency(null, "HQ", true) ?? [];
            collectionModel = await CollectionService.SelectCollection("HQ", DateTime.Today.AddDays(-1));

            collectionModel = collectionModel.Where(x => x.flngCollectionNumber == selectedCollectionNumber);

            sumCollectionTypeModel = collectionModel.GroupBy(c => c.flngCollectionTypeKey)
                                                    .Select(c => new SumCollectionTypeModel(c.Key,
                                                                                            c.Where(l => l.fstrLocationKey == "HQ")
                                                                                             .Sum(s => s.fcurLocalAmount)));

            sumPaymentTypeModel = collectionModel.GroupBy(c => c.flngPaymentTypeKey)
                                                    .Select(c => new SumPaymentTypeModel(c.Key,
                                                                                            c.Where(l => l.fstrLocationKey == "HQ")
                                                                                             .Sum(s => s.fcurLocalAmount)));
            grandTotal = collectionModel.Sum(s => s.fcurLocalAmount);
        }
        catch (Exception ex)
        {
            ToastService.ShowError(ex.Message);
        }

    }

    private async Task ResetProperties()
    {
        parameter = new()
        {
            CurrencyKey = "JMD",
            LocationKey = "HQ"
        };
        locationModel = [];
        submitting = false;
        canUpdate = false;

        await LoadAllDataAsync();
    }

    private void SelectedCollection(CollectionModel collection)
    {
        canUpdate = true;
        parameter = new()
        {
            CollectionKey = collection.flngCollectionKey,
            Firstname = collection.fstrFirstname,
            Lastname = collection.fstrLastname,
            EmailAddress = collection.fstrEmailAddress,
            TransactionDate = collection.fdtmTransactionDate,
            CollectionNumber = collection.flngCollectionNumber,
            MemberStatusKey = collection.flngMemberStatusKey,
            CollectionTypeKey = collection.flngCollectionTypeKey,
            PaymentTypeKey = collection.flngPaymentTypeKey,
            Amount = collection.fcurAmount,
            LocalAmount = collection.fcurLocalAmount,
            CurrencyKey = collection.fstrCurrencyKey,
            When = collection.fdtmWhen
        };
    }

    private bool SearchCollection(CollectionModel collection, string searchText)
    {
        if (string.IsNullOrWhiteSpace(searchText))
            return true;

        return collection.fstrFirstname!.Contains(searchText, StringComparison.OrdinalIgnoreCase)
         || collection.fstrLastname!.Contains(searchText, StringComparison.OrdinalIgnoreCase)
         || MemoryStoredData.GetMemberStatus().FirstOrDefault(c => c.flngMemberStatusKey == collection.flngMemberStatusKey)!.fstrMemberStatus!.Contains(searchText, StringComparison.OrdinalIgnoreCase);
    }

    private void OnDateChanged(DateTime? newDate)
    {
        if (!newDate.HasValue)
            return;

        parameter.TransactionDate = newDate.Value;
       
        currencyModel = currencyModel.Where(c => c.fdtmEffectiveFrom.Date <= parameter.TransactionDate &&
                                            c.fdtmEffectiveTo.Date >= parameter.TransactionDate);
    }

    private async Task OnFormSubmit()
    {
        submitting = true;
        await Task.Delay(1000);

        try
        {
            if (parameter.CollectionNumber == 0)
                return;

            if (currencyModel.Count() != 0)
            {
                var rate = currencyModel.Where(x => x.fstrCurrencyKey == parameter.CurrencyKey &&
                                               x.fdtmEffectiveFrom <= parameter.TransactionDate &&
                                               x.fdtmEffectiveTo >= parameter.TransactionDate)
                                        .Select(x => x.fcurAmount)
                                        .FirstOrDefault();

                if(rate != 0)
                {
                    parameter.LocalAmount = parameter.Amount * rate;
                }
            }

            var message = await (canUpdate ? CollectionService.AddOrUpdateCollection(parameter, false) : CollectionService.AddOrUpdateCollection(parameter));

            ToastService.Show(message.Type, message.Message!);
        }
        catch (Exception ex)
        {
            ToastService.ShowError(ex.Message);
        }
        finally
        {
            await ResetProperties();
        }
    }

}
